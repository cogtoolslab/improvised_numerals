<!doctype html>
<html>
  <style>
    #instructions {
      color: #FFFFFF;
      width: 70%;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
      margin-top: 200px;
      margin-bottom: auto;
      text-align: center;
    }
    #main_image {
      /* width: 10%; */
      margin-left: auto;
      margin-right: auto;
      margin-top: 100px;
      margin-bottom: auto;
    }
    #main_image img {
      margin-left: auto;
      margin-right: auto;
      display: block;
    }
    #animals {
      margin-left: auto;
      margin-right: auto;
      margin-top: 50px;
      margin-bottom: auto;
    }
    #cardinalities {
      margin-left: auto;
      margin-right: auto;
      margin-top: 50px;
      margin-bottom: auto;
    }
    </style>
    
  <head>
    <title> Sketch Matching </title>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/snap.svg-min.js"></script>
    <script src="js/jspsych.js"></script>
    <script src="js/jspsych-nAFC-circle.js"></script>
    <script src="js/jspsych-instructions.js"></script>
    <script src="js/lodash.min.js"></script>
    <!-- <script src="js/object_list.js"></script> -->
    <script src="js/setup.js"></script>
    <link rel="stylesheet" href="./custom.css"></link>

    <script>

      // make sure we have lodash; if we don't, then import it
      var has_require = typeof require !== 'undefined';
      if( typeof _ === 'undefined' ) {
        if( has_require ) {
          _ = require('lodash');
          utils  = require(__base + 'utils/sharedUtils.js');
        }
        else throw 'mymodule requires underscore, see http://underscorejs.org';
      };

      // not sure what 'setupGame()' this is calling, as it doesn't appear to be the one defined in setup.js
      window.onload = function() {
        setupGame();
        console.log("This was it")
      }

      // window.onbeforeunload = function() {
      //   return "Data will be lost if you leave the page, are you sure?";
      // };
      var batch = "batch_1.txt"
      var condition = _.sample(['shape','number']);
    </script>
  </head>


  <body>
    <div id="display-area"></div>

    <!-- Instructions DIV is hidden once they 
    click the button. Default instruction text is for number condition -->
    <div id="instructions">
      <p>
        You will see a series of sketches.
        Please click the number that you think each sketch was depicting!
      </p>

      <!-- different text if the condition is actually shape -->
      <script>
        if (condition == 'shape'){$( "p" ).text( "You will see a series of sketches.\
        Please click the animal that you think each sketch was depicting!" )};
      </script>

      <button id="startExperimentButton">
        Click here to begin
      </button>
    </div>

    <div id="main_image">
      <img id="stim" src="https://upload.wikimedia.org/wikipedia/commons/7/75/Herdwick_sheep_-_geograph.org.uk_-_7096_%28cropped%29.jpg"
      width="240" height="240" alt="Image"/>
    </div>


    <div id="cardinalities">
      <center>
        <img id="one" src="rating_buttons/button_1.png"
        width="100" height="100" background="#FFFFFF" alt="Choice 1"/>
        <img id="two" src="rating_buttons/button_2.png"
        width="100" height="100" alt="Choice 2"/>
        <img id="three" src="rating_buttons/button_3.png"
        width="100" height="100" alt="Choice 3"/>
        <img id="four" src="rating_buttons/button_4.png"
        width="100" height="100" alt="Choice 4"/>
        <img id="five" src="rating_buttons/button_5.png"
        width="100" height="100" background="#FFFFFF" alt="Choice 1"/>
        <img id="six" src="rating_buttons/button_6.png"
        width="100" height="100" alt="Choice 2"/>
        <img id="seven" src="rating_buttons/button_7.png"
        width="100" height="100" alt="Choice 3"/>
        <img id="eight" src="rating_buttons/button_8.png"
        width="100" height="100" alt="Choice 4"/>
      </center>
    </div>

    <div id="animals">
      <center>
        <img id="bear" src="rating_buttons/button_bear.png"
        width="180" height="180" alt="Choice Bear"/>
        <img id="deer" src="rating_buttons/button_deer.png"
        width="180" height="180" alt="Choice Deer"/>
        <img id="owl" src="rating_buttons/button_owl.png"
        width="180" height="180" alt="Choice Owl"/>
        <img id="rabbit" src="rating_buttons/button_rabbit.png"
        width="180" height="180" alt="Choice Rabbit"/>
      </center>
    </div>


  
    <script>
      
      var curTrial = 0; /* we want to use this as 
          index into trialList, so start at 0 */
      var curTrialTimeStarted = 0;
      
      // $("#instructions").text("You will see a series of sketches. \
      //   Please click the animal that you think each sketch was depicting!");

      $("#main_image").hide();
      $("#animals").hide();
      $("#cardinalities").hide();

      $("#startExperimentButton").on("click", StartExperiment);
      // is there some way of condensing the following blocks of code (the ones making all the buttons dynamic?)
      $("#bear").on("click", function(){HapticFeedback($("#bear"))});
      $("#deer").on("click", function(){HapticFeedback($("#deer"))});
      $("#owl").on("click", function(){HapticFeedback($("#owl"))});
      $("#rabbit").on("click", function(){HapticFeedback($("#rabbit"))});

      $("#one").on("click", function(){HapticFeedback($("#one"))});
      $("#two").on("click", function(){HapticFeedback($("#two"))});
      $("#three").on("click", function(){HapticFeedback($("#three"))});
      $("#four").on("click", function(){HapticFeedback($("#four"))});
      $("#five").on("click", function(){HapticFeedback($("#five"))});
      $("#six").on("click", function(){HapticFeedback($("#six"))});
      $("#seven").on("click", function(){HapticFeedback($("#seven"))});
      $("#eight").on("click", function(){HapticFeedback($("#eight"))});


      /* This gets called when they click the button 
        on the instructions page */
        function StartExperiment() {
        $("#instructions").hide();
          AdvanceSlide();
        };

        function AdvanceSlide() {
          // sample images:
          // https://pm1.narvii.com/7595/d24a5bc3694025c77ff69cec25ebe8d5e542dc4er1-256-256v2_00.jpg
          // https://upload.wikimedia.org/wikipedia/commons/7/75/Herdwick_sheep_-_geograph.org.uk_-_7096_%28cropped%29.jpg

          var curTime = new Date(); // for measuring RT
          var reaction_time = curTime - curTrialTimeStarted; // for measuring RT

          // now create the data structure we want to store for this trial on mongodb:
          var output = {
            trial_num : curTrial, 
            condition : 'game_cond', // is the rater being asked to select cardinalities or animals?
            sketch_id : 'SketchID',
            sketch_animal : 'animal',
            sketch_cardinality : 'cardinality',
            RT : reaction_time,
            label : 'something'}; // which label did the rater select?

          
          // a bit of nonsense filler at the moment. We want to fill this in with the actual sketches
          if (curTrial == 0){
            $("#stim").attr("src",
            "https://iternum-sketches.s3.amazonaws.com/2824-66e43315-075a-431f-86d4-6eea7f135aa2•owl_4•6•shape•owl_5_012.png"
            );
            document.getElementById("stim").style.backgroundColor = "#FFFFFF";
            curTrial = 1;
          } else {
            $("#stim").attr("src",
            "https://upload.wikimedia.org/wikipedia/commons/7/75/Herdwick_sheep_-_geograph.org.uk_-_7096_%28cropped%29.jpg"
            );
            document.getElementById("stim").style.backgroundColor = "#FFFFFF";
            curTrial = 0;
          };


          // displaying the new sketch for them to rate, and all the buttons
          $("#main_image").show();
          if (condition == 'number') {
            $("#cardinalities").show();
          };
          if (condition == 'shape') {
            $("#animals").show();
          };
          
          curTrialTimeStarted = new Date(); // for measuring RT
        };

        function HapticFeedback(button) {

          // want to make accidental double clicks irrelevant by setting off the sensitivity
          button.off("click")
          button.fadeTo(1, 0); // and also make it visually obvious what the choice was
          button.fadeTo(350, 1); // but also make sure the button reappears so we know that we can click it again
          setTimeout(function(){button.on("click",function(){HapticFeedback(button)})}, 500); // make it clickable after 500ms
          
          AdvanceSlide() // the actual function that will change the sketch and trial number




          // a function to write to a textfile from https://www.thecrazyprogrammer.com/2019/12/javascript-read-and-write-to-text-file.html    
          // import fs module in which writeFile function is defined. 
          const fsLibrary  = require('fs')
          // Data which will need to add in a file. 
          let data = "Slide has been advanced"
          // Write data in 'newfile.txt' . 
          fsLibrary.writeFile('testing.txt', data, (error) => { 
              // In case of a error throw err exception. 
              if (error) throw err; 
          });
  
        };


        // function setupGame() {
        //   // first we want to generate the list of images. 1 image from each game

        // }
    </script>




  </body>
</html>
